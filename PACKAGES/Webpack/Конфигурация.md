# Webpack

## Установка

```bash
# инициализация npm
npm init -y

# установка webpack и webpack-cli (интерфейс командной строки)
npm i webpack webpack-cli -D

# установка виртуального сервера
npm i webpack-dev-server -D

# установка плагина для работы с html
npm i html-webpack-plugin -D

# установка лоадеров для работы с css
npm i css-loader style-loader -D

# установка лоадеров для работы с scss
npm i sass-loader -D

# установка плагина для объединения css в один файл
npm i mini-css-extract-plugin -D

# установка babel
npm i @babel/core @babel/preset-env babel-loader -D

# установка плагина для объединения конфигов
npm i webpack-merge -D
```

## Конфигурация

Все плагины нужно подключать в `webpack.config.js`, лоадеров не нужно подключать, они указываются в секции `module`.

### `webpack.config.js` или `webpack.config.mjs`

Конфигурация должна возвращать объект. Можно экспортировать объект или экспортировать функцию, которая возвращает объект. Или создать в начале файла объект и далее его экспортировать.

Все значения можно получить динамически из окружения через объект `env`. Для этого нужно создать в `webpack.config.js` функцию, которая принимает объект `env` и возвращает сгенерированный объект настроек.

```js
// 1 Вариант
module.exports = env => {
  return {
    mode: 'none',
  };
};

// 2 Вариант
module.exports = {
  mode: 'none',
};

// 3 Вариант
const object = {
  mode: 'none',
};
module.exports = object;

// 4 Вариант для webpack.config.mjs
export default {
  mode: 'none',
};
```

### `mode`

```js
mode: 'development';
```

Определяет режим сборки.

- `production` - режим продакшн
- `development` - режим разработки
- `none` - отключает любые параметры оптимизации по умолчанию

### `entry`

Отправная точка, от которой будут отслеживаться и попадать в сборку все зависимости. Может быть одна или несколько. Если мы ничего не настраиваем, то по умолчанию используется адрес `./src/index.js`. Но хорошей практикой считается явное указание точки входа. В качестве значения используется строка или объект с разными точками входа.

```js
entry: './src/index.js';

entry: {
  main: './src/index.js';
}
```

### `output`

Точка выхода. Папка для сохранения результатов сборки. Имя собираемого js-файла. В качестве значения указывается объект. Для удобства обычно используется утилита из `Node.js`, а именно метод `path.resolve()`. Тогда полный адрес для webpack будет правильным.

```js
output: {
  filename: 'main.js',
  path: path.resolve('./dist'),
}
```

### `module`

Основная конфигурация, где мы указываем к какому файлу какой применить плагин. В качестве значения указывается объект с ключем `rules` - массив объектов с настройками.

```js
module: {
  rules: [
    {
      test: /* регулярное выражение для поиска файлов */,

      // массив лоадеров, которые будут использоваться для найденных файлов
      // обработка будет идти справо налево (т.е. с конца массива)
      use: [
        /* 1 вариант - просто строка 'имя лоадера' */
        /* 2 вариант - или более подробный {объект лоадера} */
        {
          loader: /* имя лоадера */,
          query: /* объект дополнительных опций */
        }
      ]
    }
  ]
}
```

### `plugins`

Добавление дополнительных возможностей для обработки зависимостей. Плагины подключаются и вызываются. В качестве значения указывается массив.

```js
const HtmlWebpackPlugin = require('html-webpack-plugin');
const { CleanWebpackPlugin } = require('clean-webpack-plugin');
const MiniCssExtractPlugin = require('mini-css-extract-plugin');

plugins: [
  new HtmlWebpackPlugin({
    template: './src/index.html',
  }),
  new CleanWebpackPlugin(),
  new MiniCssExtractPlugin({
    filename: 'main.css',
  }),
],
```

### `devServer`

Содержит объект с настройками для виртуального сервера `webpack-dev-server`.

```js
devServer: {
  // отслеживает изменения файлов в папке
  // watchFiles: path.join(__dirname, 'src'),
  // сжатие файлов, ускорит загрузку в режиме разработки
  // compress: true,
  // порт, чтобы открывать сайт по адресу localhost:8080
  // port: 8080,
  // сайт будет открываться автоматически
  // open: true,
  // где собирается проект
  // static: path.resolve(__dirname, './dist'),
},
```

## Скрипты

```json
{
  "webpack": "webpack",
  "dev1": "webpack-dev-server --env mode=development",
  "dev2": "webpack-dev-server --mode=development",
  "dev3": "webpack serve --mode=development",
  "dev4": "webpack --env mode=development --watch",
  "dev5": "webpack --mode=development --watch",
  "build": "webpack --env mode=production"
}
```

### `webpack`

Запустит сборку.

### `--watch`

Режим отслеживания изменения файлов.

### `--env mode=development`

`--env mode` - это объект `env` с ключем `mode`. Мы передаем ему значение `development`. Для того чтобы переменная окружения была доступна в файле настроек `webpack.config.js` нужно однозначно чтобы `webpack.config.js` был экспортированной функцией, которая принимает объект `env`.

```js
// webpack.config.js (без деструктуризации)
module.exports = env => {
  return {
    mode: env.mode,
  };
};

// webpack.config.js (с деструктуризацией)
module.exports = ({ mode }) => {
  return {
    mode: mode,
  };
};
```
